# Library REST API  
**Лабораторная работа №1 «Проектирование и реализация REST API»**

---

## Цель работы

Закрепить принципы проектирования REST API:

- простота и предсказуемость;
- стабильность контрактов;
- версионность API;
- идемпотентность операций;
- ограничение частоты запросов (rate limiting);
- документирование API в формате OpenAPI (Swagger).

---

## 1. Предметная область

Предметная область — **система управления библиотекой**.

### Сущности и связи

#### User (пользователь)

- `id` — идентификатор;
- `email` — логин, уникальный;
- `password_hash` — хэш пароля;
- `created_at` — дата регистрации.

#### Book (книга)

- `id` — идентификатор книги;
- `title` — название;
- `author` — автор;
- `isbn` — ISBN;
- `published_year` — год издания;
- `is_available` — доступность книги;
- `genre` — жанр (добавлено в v2 API);
- `pages` — количество страниц (добавлено в v2 API).

#### Loan (выдача книги)

- `id` — идентификатор выдачи;
- `book_id` — внешний ключ на `books.id`;
- `user_id` — внешний ключ на `users.id`;
- `loan_date` — дата выдачи;
- `return_date` — дата возврата (опционально).

### Связи

- Один пользователь может иметь несколько выдач (User → Loan, связь 1:N)
- Одна книга может быть выдана несколько раз в разное время (Book → Loan, связь 1:N)

Реализация выполнена с использованием **Entity Framework Core (InMemory Database)**.

---

## 2. Проектирование API (ресурсы и конечные точки)

### Базовая структура URL

- /api/v{version}/{resource}


### Ресурсы

- `auth` — регистрация и аутентификация пользователей;
- `books` — управление книгами;
- `loans` — выдача и возврат книг.

### Примеры конечных точек (v1)

#### Auth v1

- `POST /api/v1/auth/register` — регистрация пользователя
- `POST /api/v1/auth/login` — вход и получение JWT-токена

#### Books v1

- `GET /api/v1/books` — список книг
- `GET /api/v1/books/{id}` — получить книгу по id
- `POST /api/v1/books` — добавить книгу
- `PUT /api/v1/books/{id}` — обновить книгу
- `DELETE /api/v1/books/{id}` — удалить книгу

#### Loans v1

- `POST /api/v1/loans` — выдать книгу
- `POST /api/v1/loans/{id}/return` — вернуть книгу
- `GET /api/v1/loans/my` — список выдач текущего пользователя

API построен по REST-принципам:  
ресурсы во множественном числе, действия определяются HTTP-методами (GET, POST, PUT, DELETE).

---

## 3. Версионность и аддитивные изменения

В проекте реализовано **URL-based версионирование API**.

### Реализованные версии

- **v1** — базовая стабильная версия API
- **v2** — расширенная версия API

### Отличия v2 (аддитивные изменения)

#### Books v2

- `GET /api/v2/books` — возвращает книги с дополнительными полями:
  - `genre`
  - `pages`

В версии v1 данные поля отсутствуют в контракте.  
Добавление новых полей выполнено без нарушения работы существующих клиентов.

### Ломающие изменения

К ломающим изменениям относятся:

- удаление или переименование полей;
- изменение типов данных;
- изменение URL эндпоинтов.

Такие изменения не выполнялись — вместо этого используется новая версия API.

---

## 4. Аутентификация (JWT)

Для аутентификации используется **JWT (JSON Web Token)** со схемой `Bearer`.

### Причины выбора JWT

- Stateless-подход;
- подходит для REST API;
- простая интеграция;
- возможность масштабирования.

### Использование

1. Получение токена:
- POST /api/v1/auth/login
2. Использование токена:
- Authorization: Bearer <JWT>

---

## 5. Идемпотентность

Идемпотентность реализована для операций создания ресурсов:

- `POST /api/v1/loans`
- `POST /api/v2/loans`

### Используемый заголовок

- Idempotency-Key: <уникальный_ключ>

### Поведение

- первый запрос создаёт ресурс;
- повторный запрос с тем же ключом не создаёт дубликат;
- возвращается ранее сохранённый результат.

---

## 6. Ограничение частоты запросов (Rate Limiting)

Для всех эндпоинтов включено ограничение частоты запросов.

### Параметры

- 10 запросов в минуту на пользователя;
- алгоритм Token Bucket.

### Поведение

- статус `429 Too Many Requests`;
- заголовок `Retry-After`.

---

## 7. Документация API (OpenAPI / Swagger)

Документация генерируется автоматически с использованием Swagger.

### Доступные адреса

- Swagger UI:
  /swagger
- OpenAPI JSON:
  /swagger/v1/swagger.json
  /swagger/v2/swagger.json

Документация включает все версии API, эндпоинты, схемы запросов и ответов, а также поддержку JWT.

---

## 8. Инструкция по запуску

### Требования

- .NET SDK 8.0+

### Запуск

```bash
dotnet restore
dotnet run
